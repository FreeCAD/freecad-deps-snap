name: Publish on demand

on:
  workflow_dispatch: # Allows manual triggering

env:
  # Log path location for containerized builds
  LOG_PATH: /home/runner/.local/state/snapcraft/log/

jobs:
  build-and-publish:
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm64

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build snap in isolated container
        id: build
        uses: canonical/action-build@v1
        with:
          snapcraft-channel: latest/stable
          snapcraft-args: --verbose

      - name: Publish snap to Snap Store
        # Conditions: only on success, and not on forks
        if: steps.build.outcome == 'success' && github.repository_owner == 'FreeCAD'
        uses: canonical/action-publish@v1
        with:
          # The action's output provides the snap path directly
          snap: ${{ steps.build.outputs.snap }}
          release: edge
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.STORE_LOGIN }}

      - name: Upload snap package artifact
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: snap-package-${{ matrix.arch }}
          path: ${{ steps.build.outputs.snap }}

      - name: Upload log artifact
        # Ensure this runs even if the build fails
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snapcraft-log-${{ matrix.arch }}
          path: ${{ env.LOG_PATH }}/*
